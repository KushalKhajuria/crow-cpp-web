<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online Othello</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-1: #f2f8ed;
        --bg-2: #d2ead8;
        --board-dark: #14532d;
        --board-mid: #15803d;
        --panel: #ffffff;
        --ink: #0f172a;
      }

      body {
        font-family: "Space Grotesk", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at 10% 10%, var(--bg-1), var(--bg-2));
      }
    </style>
  </head>

  <body class="min-h-screen p-4 md:p-8">
    <main class="mx-auto max-w-7xl space-y-6">
      <header class="rounded-2xl border border-emerald-200/80 bg-white/90 p-5 shadow-sm backdrop-blur">
        <h1 class="text-3xl font-bold tracking-tight">Online Othello</h1>
        <p class="text-sm text-slate-600">Crow + C++ backend with a Figma-inspired lobby and game board.</p>
        <div id="status" class="mt-3 text-sm"></div>
      </header>

      <section class="grid gap-6 lg:grid-cols-[1.1fr_1fr]">
        <div class="space-y-6">
          <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <h2 class="mb-3 text-lg font-semibold">Account</h2>
            <div class="grid gap-3">
              <label class="text-sm font-medium">Username</label>
              <input id="user" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="kushal" />

              <label class="text-sm font-medium">Password</label>
              <input id="pass" type="password" class="w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="password123" />

              <div class="mt-1 flex flex-wrap gap-2">
                <button onclick="register()" class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-black">Register</button>
                <button onclick="login()" class="rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700">Login</button>
                <button onclick="logout()" class="ml-auto rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700">Logout</button>
              </div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <h2 class="mb-3 text-lg font-semibold">Game Lobby</h2>
            <label class="text-sm font-medium">Opponent username</label>
            <input id="opponent" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2" placeholder="friend_username" />

            <div class="mt-3 flex flex-wrap gap-2">
              <button onclick="runGame()" class="rounded-lg bg-emerald-700 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-800">Create Game</button>
              <button onclick="resignGame()" class="rounded-lg bg-rose-600 px-4 py-2 text-sm font-medium text-white hover:bg-rose-700">Resign</button>
              <button onclick="offerDraw()" class="rounded-lg bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700">Offer Draw</button>
              <button id="acceptDrawBtn" onclick="acceptDraw()" class="hidden rounded-lg bg-slate-700 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">Accept Draw</button>
            </div>

            <div id="gameOut" class="mt-3 text-sm text-slate-700"></div>
            <div id="gameMeta" class="mt-2 text-xs text-slate-500"></div>
          </div>
        </div>

        <div id="boardWrap" class="hidden rounded-2xl border border-emerald-800/30 bg-white p-5 shadow-sm">
          <div class="mb-4 grid gap-3 sm:grid-cols-3">
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
              <p class="text-xs uppercase tracking-wide text-slate-500">Black</p>
              <p id="blackScore" class="text-2xl font-bold">2</p>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
              <p class="text-xs uppercase tracking-wide text-slate-500">White</p>
              <p id="whiteScore" class="text-2xl font-bold">2</p>
            </div>
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
              <p class="text-xs uppercase tracking-wide text-slate-500">Turn</p>
              <p id="currentTurn" class="text-lg font-semibold">Black</p>
            </div>
          </div>

          <div class="inline-block rounded-xl bg-[var(--board-dark)] p-3 shadow-inner">
            <div id="board" class="grid grid-cols-8 gap-0 overflow-hidden rounded-md border-2 border-emerald-950 bg-[var(--board-mid)]"></div>
          </div>

          <div id="boardPos" class="mt-3 text-sm text-slate-600"></div>
          <p class="mt-2 text-xs text-slate-500">Board updates via polling.</p>
        </div>
      </section>
    </main>

    <script>
      const statusEl = document.getElementById("status");

      function setStatus(msg, ok = true) {
        statusEl.className = "mt-3 text-sm " + (ok ? "text-emerald-700" : "text-rose-700");
        statusEl.innerText = msg;
      }

      async function api(path, options = {}) {
        const r = await fetch(path, {
          ...options,
          headers: { "Content-Type": "application/json", ...(options.headers || {}) },
        });

        const text = await r.text();
        let data = null;
        try {
          data = text ? JSON.parse(text) : null;
        } catch {
          // ignore
        }

        return { ok: r.ok, status: r.status, text, data };
      }

      let currentUser = null;

      async function refreshMe() {
        const r = await fetch("/api/me");
        const text = await r.text();
        try {
          const j = JSON.parse(text);
          if (r.ok && j.username) {
            currentUser = j.username;
            setStatus(`Logged in as ${j.username}`);
          } else {
            currentUser = null;
            setStatus("Not logged in", false);
          }
        } catch {
          currentUser = null;
          setStatus(r.ok ? "OK" : text || "Not logged in", r.ok);
        }
      }

      async function register() {
        const username = document.getElementById("user").value.trim();
        const password = document.getElementById("pass").value;

        const res = await api("/api/register", {
          method: "POST",
          body: JSON.stringify({ username, password }),
        });

        if (res.ok) {
          setStatus("Registered! Now login.");
        } else {
          setStatus(res.data?.message || res.text || `Register failed (${res.status})`, false);
        }
      }

      async function login() {
        const username = document.getElementById("user").value.trim();
        const password = document.getElementById("pass").value;

        const res = await api("/api/login", {
          method: "POST",
          body: JSON.stringify({ username, password }),
        });

        if (res.ok) {
          setStatus("Logged in!");
          await refreshMe();
        } else {
          setStatus(res.text || `Login failed (${res.status})`, false);
        }
      }

      async function logout() {
        const res = await api("/api/logout", { method: "POST", body: "{}" });
        if (res.ok) setStatus("Logged out.");
        else setStatus(res.text || `Logout failed (${res.status})`, false);
        currentUser = null;
        await refreshMe();
      }

      let gameId = null;
      let pollId = null;

      function sideLabel(side) {
        if (side === 1) return "Black";
        if (side === -1) return "White";
        return "-";
      }

      function updateBoardStats(board, turn) {
        const blackEl = document.getElementById("blackScore");
        const whiteEl = document.getElementById("whiteScore");
        const turnEl = document.getElementById("currentTurn");

        let black = 0;
        let white = 0;
        for (let r = 0; r < board.length; r++) {
          for (let c = 0; c < board[r].length; c++) {
            if (board[r][c] === 1) black++;
            else if (board[r][c] === -1) white++;
          }
        }

        blackEl.textContent = String(black);
        whiteEl.textContent = String(white);
        turnEl.textContent = sideLabel(turn);
      }

      function setGameMeta(state) {
        const meta = document.getElementById("gameMeta");
        if (!state) {
          meta.textContent = "";
          return;
        }
        const offer = state.draw_offer_by ? ` - Draw offered by ${state.draw_offer_by}` : "";
        meta.textContent = `Game #${state.game_id} - ${state.player1} vs ${state.player2} - Turn: ${sideLabel(state.turn)}${offer}`;
      }

      function endGameUi(message) {
        const wrap = document.getElementById("boardWrap");
        const out = document.getElementById("gameOut");
        const acceptBtn = document.getElementById("acceptDrawBtn");
        if (pollId) clearInterval(pollId);
        pollId = null;
        gameId = null;
        acceptBtn.classList.add("hidden");
        wrap.classList.add("hidden");
        out.textContent = message || "Game finished. Start a new game.";
      }

      function updateDrawButtons(state) {
        const acceptBtn = document.getElementById("acceptDrawBtn");
        const canAccept =
          !!state &&
          !!state.draw_offer_by &&
          !!currentUser &&
          state.draw_offer_by !== currentUser &&
          state.status === "active";
        acceptBtn.classList.toggle("hidden", !canAccept);
      }

      function gameEndMessage(state) {
        if (!state || !state.status || state.status === "active") {
          return "Game finished. Start a new game.";
        }
        if (state.status === "finished") {
          if (state.winner === "draw" || state.winner_side === 0) return "Game over. It's a draw.";
          if (state.winner) return `Game over. Winner: ${state.winner}.`;
          return "Game over.";
        }
        if (state.status === "draw") return "Draw accepted. Game ended.";
        if (state.status === "resigned") return state.winner ? `Resigned. Winner: ${state.winner}.` : "Game ended by resignation.";
        return `Game ended (${state.status}).`;
      }

      function startPolling() {
        if (pollId) clearInterval(pollId);
        pollId = setInterval(async () => {
          const boardEl = document.getElementById("board");
          await refreshBoard(boardEl);
        }, 1500);
      }

      async function runGame() {
        const out = document.getElementById("gameOut");
        const wrap = document.getElementById("boardWrap");
        const boardEl = document.getElementById("board");
        const opponent = document.getElementById("opponent").value.trim();
        out.textContent = "Starting game...";

        const res = await api("/api/games/create", {
          method: "POST",
          body: JSON.stringify({ opponent }),
        });

        if (res.ok) {
          gameId = res.data?.game_id;
          out.textContent = gameId ? `Game created (#${gameId}).` : "Game created.";
          if (gameId) {
            const url = new URL(window.location.href);
            url.searchParams.set("game", String(gameId));
            window.history.replaceState({}, "", url.toString());
          }
          await refreshBoard(boardEl);
          wrap.classList.remove("hidden");
          startPolling();
        } else {
          out.textContent = res.text || `Failed to start game (${res.status})`;
        }
      }

      async function refreshBoard(boardEl) {
        if (!gameId) return;
        const res = await api(`/api/games/${gameId}/state`, { method: "GET" });
        if (!res.ok) return;
        if (res.data?.status && res.data.status !== "active") {
          endGameUi(gameEndMessage(res.data));
          return;
        }
        if (res.data?.message) {
          const out = document.getElementById("gameOut");
          out.textContent = res.data.message;
        }
        setGameMeta(res.data);
        updateDrawButtons(res.data);
        renderBoard(boardEl, res.data?.board || []);
        updateBoardStats(res.data?.board || [], res.data?.turn);
      }

      async function makeMove(row, col) {
        const boardEl = document.getElementById("board");
        const pos = document.getElementById("boardPos");
        pos.textContent = `Row: ${row}, Col: ${col}`;

        if (!gameId) return;
        const res = await api(`/api/games/${gameId}/move`, {
          method: "POST",
          body: JSON.stringify({ row, col }),
        });

        if (res.ok) {
          if (res.data?.status && res.data.status !== "active") {
            endGameUi(gameEndMessage(res.data));
            return;
          }
          if (res.data?.message) {
            const out = document.getElementById("gameOut");
            out.textContent = res.data.message;
          }
          setGameMeta(res.data);
          updateDrawButtons(res.data);
          renderBoard(boardEl, res.data?.board || []);
          updateBoardStats(res.data?.board || [], res.data?.turn);
        } else {
          if (res.data?.board) {
            renderBoard(boardEl, res.data.board);
            updateBoardStats(res.data.board, res.data?.turn);
          }
        }
      }

      async function resignGame() {
        if (!gameId) return;
        const res = await api(`/api/games/${gameId}/resign`, { method: "POST", body: "{}" });
        if (res.ok) {
          endGameUi(`Resigned. Winner: ${res.data?.winner || "opponent"}.`);
        }
      }

      async function offerDraw() {
        if (!gameId) return;
        const res = await api(`/api/games/${gameId}/offer-draw`, { method: "POST", body: "{}" });
        if (res.ok) {
          const out = document.getElementById("gameOut");
          out.textContent = "Draw offered.";
          await refreshBoard(document.getElementById("board"));
        }
      }

      async function acceptDraw() {
        if (!gameId) return;
        const res = await api(`/api/games/${gameId}/accept-draw`, { method: "POST", body: "{}" });
        if (res.ok) {
          endGameUi("Draw accepted. Game ended.");
        }
      }

      function renderBoard(boardEl, board) {
        const size = board.length || 8;
        boardEl.innerHTML = "";
        for (let r = 0; r < size; r++) {
          for (let c = 0; c < size; c++) {
            const cell = document.createElement("button");
            cell.type = "button";
            cell.dataset.row = String(r);
            cell.dataset.col = String(c);
            cell.className =
              "h-10 w-10 border border-emerald-900 bg-emerald-700 transition hover:bg-emerald-600 sm:h-12 sm:w-12" +
              " flex items-center justify-center";

            const v = board[r]?.[c] ?? 0;
            if (v !== 0) {
              const disc = document.createElement("div");
              disc.className =
                "h-7 w-7 rounded-full shadow-inner sm:h-9 sm:w-9 " +
                (v === 1
                  ? "border-2 border-slate-700 bg-gradient-to-br from-slate-600 to-slate-900"
                  : "border-2 border-slate-300 bg-gradient-to-br from-white to-slate-200");
              cell.appendChild(disc);
            }

            cell.addEventListener("click", () => {
              makeMove(r, c);
            });

            boardEl.appendChild(cell);
          }
        }
      }

      refreshMe();
      (async () => {
        const gameParam = new URLSearchParams(window.location.search).get("game");
        if (gameParam) {
          gameId = Number(gameParam);
        } else {
          const res = await api("/api/games/active", { method: "GET" });
          if (res.ok) gameId = res.data?.game_id || null;
        }

        if (gameId) {
          const wrap = document.getElementById("boardWrap");
          const boardEl = document.getElementById("board");
          wrap.classList.remove("hidden");
          refreshBoard(boardEl);
          startPolling();
        }
      })();
    </script>
  </body>
</html>
